<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="www.thymeleaf.org"&gt;>
<head th:replace="components :: head(${page}, ~{::meta})">
  <meta charset="UTF-8">
</head>
<body>
<div class="page-container">
   <th:block th:replace="components :: header"></th:block>
      <main>
        <div id="podcast-header">
            <div id="podcast-cover">
                <img th:src="${podcast.cover}" alt="pdc_img">
            </div>
            <div id="podcast-info">
                <h1 th:text="${podcast.name}"></h1>
                <p th:text="${podcast.description}"></p>
            </div>
        </div>
        <div id="podcast-field">
            <div id="podcast-episodes">
                <h1 class="mb-4">Episódios</h1>
                <div id="podcast-episodes-list">
                	<th:block th:each="ep : ${episodes}">
                    	<th:block th:replace="components :: episode(${ep})"></th:block>
                	</th:block>
                </div>
            </div>
            <div id="podcast-creator">
            	<th:block th:replace="components :: user"></th:block>
            </div>
        </div>
      </main>

      <th:block th:replace="components :: player"></th:block>
  	  <th:block th:replace="components :: scripts(${page})"></th:block>
      <script>
          $(function() {
              $('audio').audioPlayer();
          });

          $('#select-cover').on('click', e => {
              $('input[type=file]').click()
          })
          
          // FUNÇÃO QUE FORMATA O TEMPO DE DURAÇÃO DOS EPISÓDIOS
          function format(time) {
		    var hrs = ~~(time / 3600);
		    var mins = ~~((time % 3600) / 60);
		    var secs = ~~time % 60;
		    
		    var ret = "";
		    if (hrs > 0) {
		        ret += "" + hrs + ":" + (mins < 10 ? "0" : "");
		    }
		    ret += "" + mins + ":" + (secs < 10 ? "0" : "");
		    ret += "" + secs;
		    
		    return ret;
          }
          
          $('.episode-duration').map((i, el) => {
              el.textContent = format(el.textContent)
          });
          
          $('.episode').each((i, episodeEl) => {
            // FAZ A REQUISIÇÃO DO LIKE PARA O SERVIDOR
            $(episodeEl).find('.reaction-button').on('click', e => {
                let button = e.currentTarget
                button.disabled = true

                let form_episode_id = episodeEl.dataset.episode_id

                fetch('/reaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `form_episode_id=${form_episode_id}`
                }).then(response => response.json()).then(res => {
                    $(button).toggleClass('liked')

                    button.disabled = false
                    
                    // AUMENTA OU DIMINUI O VALOR DO LIKE
                    let likeValueEl =  $(button).find('span')

                    if(res.like) {
                       likeValueEl.text(Number(likeValueEl.text()) + 1)
                    } else {
                        likeValueEl.text(Number(likeValueEl.text()) - 1)
                    }
                })
            })

            // DA O PLAY NO PODCAST QUANDO CLICADO NO CONTAINER DE EPISÓDIO
            $(episodeEl).find('.episode-play').on('click', e => {
                let audio_src = episodeEl.dataset.audio_src

                let audioplayer = $('.audioplayer audio')

                audioplayer.attr('src') != audio_src && audioplayer.attr('src', audio_src)
                
                $('.audioplayer-playpause').click()
            })
          })
          
      </script>
  </body>
  </html>